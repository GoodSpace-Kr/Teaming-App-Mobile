# 웹소켓 구현 가이드

## 📋 구현 완료 사항

### 1. 웹소켓 서비스 (`src/services/websocketService.ts`)

- STOMP 프로토콜 기반 웹소켓 클라이언트
- JWT 인증 지원
- 자동 재연결 기능
- 메시지 타입 안전성 보장

### 2. React Hook (`src/hooks/useWebSocket.ts`)

- 웹소켓 상태 관리
- 메시지 수신/전송
- 에러 처리
- 연결 상태 모니터링

### 3. 채팅 화면 연동

- 실시간 메시지 수신
- 텍스트/이미지/파일 전송
- 연결 상태 표시
- 에러 처리

## 🔧 웹소켓 명세서 분석 결과

### ✅ 올바른 부분들

1. **엔드포인트 구조**: Spring STOMP + SockJS 구조가 명확
2. **채널 설계**: 클라이언트↔서버 경로가 논리적
3. **메시지 스키마**: DTO 구조가 실무에 적합
4. **보안**: JWT Bearer 토큰 인증

### ⚠️ 보완 권장 사항

1. **프로토콜 보안**: 운영 환경에서는 `wss://` 사용 필수
2. **Heartbeat 설정**: 연결 유지용 설정 추가 권장
3. **에러 응답 형식**: 더 구체적인 에러 코드/메시지 구조

## 🚀 사용 방법

### 1. 기본 연결

```typescript
import { useWebSocket } from '@/src/hooks/useWebSocket';

const {
  status,
  isConnected,
  messages,
  sendTextMessage,
  sendImageMessage,
  sendFileMessage,
} = useWebSocket({
  jwt: 'your-jwt-token',
  roomId: 123,
  autoConnect: true,
});
```

### 2. 메시지 전송

```typescript
// 텍스트 메시지
sendTextMessage('안녕하세요!');

// 이미지 메시지
sendImageMessage('이미지 설명', [fileId1, fileId2]);

// 파일 메시지
sendFileMessage('파일 설명', [fileId1]);
```

### 3. 연결 상태 확인

```typescript
if (isConnected) {
  // 연결된 상태에서 메시지 전송
  sendTextMessage('메시지');
} else {
  // 연결되지 않은 상태 처리
  console.log('웹소켓이 연결되지 않았습니다.');
}
```

## 🐛 디버깅 가이드

### 1. 연결 문제 해결

#### 문제: 웹소켓 연결 실패

**해결 방법:**

1. 서버 URL 확인: `ws://13.125.193.243:8080/ws/websocket`
2. JWT 토큰 유효성 확인
3. 네트워크 연결 상태 확인
4. 서버가 실행 중인지 확인

```typescript
// 디버그 로그 확인
console.log('JWT 토큰:', jwt);
console.log('웹소켓 상태:', status);
```

#### 문제: 메시지 전송 안됨

**해결 방법:**

1. 연결 상태 확인: `isConnected` 값
2. 방 ID 확인: `roomId` 값
3. 메시지 형식 확인: 필수 필드 누락 여부

### 2. 일반적인 에러들

#### "웹소켓이 연결되지 않았습니다"

- JWT 토큰이 없거나 만료됨
- 네트워크 연결 문제
- 서버가 다운됨

#### "STOMP 에러"

- 서버에서 인증 실패
- 방 멤버십 검사 실패
- 메시지 형식 오류

#### "메시지 파싱 에러"

- 서버에서 잘못된 JSON 전송
- 메시지 스키마 불일치

### 3. 로그 확인 방법

```typescript
// 웹소켓 서비스에서 디버그 로그 활성화
const client = new Client({
  brokerURL: 'ws://13.125.193.243:8080/ws/websocket',
  debug: (str) => console.log('[STOMP]', str), // 이 부분이 중요!
  // ... 기타 설정
});
```

## 🧪 테스트 방법

### 1. 연결 테스트

1. 앱 실행 후 채팅방 진입
2. 헤더의 연결 상태 확인 (초록색 점 = 연결됨)
3. 콘솔에서 `[STOMP]` 로그 확인

### 2. 메시지 전송 테스트

1. 텍스트 입력 후 전송 버튼 클릭
2. 콘솔에서 `📤 메시지 전송:` 로그 확인
3. 다른 사용자로 같은 방에 접속하여 메시지 수신 확인

### 3. 실시간 업데이트 테스트

1. 두 개의 디바이스/브라우저에서 같은 방 접속
2. 한쪽에서 메시지 전송
3. 다른 쪽에서 즉시 메시지 수신 확인

## 🔧 개발자 도구

### 1. 웹소켓 연결 확인

```bash
# 터미널에서 웹소켓 연결 테스트
wscat -c ws://13.125.193.243:8080/ws/websocket
```

### 2. 네트워크 모니터링

- React Native Debugger 사용
- Chrome DevTools의 Network 탭
- Flipper 사용 (iOS/Android)

### 3. 로그 필터링

```bash
# STOMP 관련 로그만 필터링
npx react-native log-android | grep STOMP
npx react-native log-ios | grep STOMP
```

## 📱 모바일 특화 고려사항

### 1. 백그라운드 처리

- 앱이 백그라운드로 갈 때 웹소켓 연결 유지
- 포그라운드 복귀 시 연결 상태 확인

### 2. 네트워크 변경 감지

- WiFi ↔ 모바일 데이터 전환 시 재연결
- 네트워크 끊김 감지 및 자동 재연결

### 3. 배터리 최적화

- 불필요한 메시지 전송 최소화
- 적절한 heartbeat 간격 설정

## 🚨 주의사항

1. **JWT 토큰 만료**: 토큰 갱신 로직 필요
2. **메모리 누수**: 컴포넌트 언마운트 시 웹소켓 연결 해제
3. **에러 처리**: 모든 웹소켓 에러에 대한 사용자 친화적 메시지
4. **보안**: 운영 환경에서는 반드시 `wss://` 사용

## 🔄 다음 단계

1. **파일 업로드 구현**: 이미지/파일 전송 시 실제 파일 업로드
2. **읽음 상태 구현**: 메시지 읽음/안읽음 표시
3. **푸시 알림 연동**: 백그라운드에서 메시지 수신 시 알림
4. **오프라인 지원**: 네트워크 끊김 시 메시지 큐잉
5. **성능 최적화**: 대용량 메시지 처리 및 가상화

## 📞 문제 해결

문제가 발생하면 다음 순서로 확인하세요:

1. **콘솔 로그 확인** - 에러 메시지 파악
2. **네트워크 상태 확인** - 인터넷 연결 및 서버 상태
3. **JWT 토큰 확인** - 유효성 및 만료 여부
4. **서버 로그 확인** - 백엔드에서 에러 발생 여부
5. **명세서 재확인** - API 스펙과 구현 일치 여부

---

이제 웹소켓이 완전히 구현되었습니다! 🎉
실제 서버와 연동하여 테스트해보세요.
